<!DOCTYPE html>
<html>
<head>
  <title>Opening Debug Test</title>
  <style>
    body { margin: 0; font-family: monospace; background: #1a1a1a; color: white; }
    #container { display: flex; height: 100vh; }
    #viewer { flex: 1; }
    #console { width: 400px; background: #2a2a2a; padding: 20px; overflow-y: auto; font-size: 12px; }
    .log { margin: 2px 0; padding: 2px 5px; }
    .info { color: #4CAF50; }
    .error { color: #f44336; }
    .warning { color: #ff9800; }
    button { margin: 5px; padding: 10px; font-size: 14px; }
  </style>
</head>
<body>
  <div id="container">
    <div id="viewer"></div>
    <div id="console">
      <h3>Debug Console</h3>
      <button id="btn-create-wall">1. Create Wall</button>
      <button id="btn-add-opening">2. Add Opening</button>
      <button id="btn-dump-state">3. Dump State</button>
      <div id="logs"></div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
    import { ParameterEngine } from './src/parametric/ParameterEngine';
    import { GeometryEngineWrapper } from './src/parametric/GeometryEngineWrapper';
    import { ParametricWall } from './src/parametric/ParametricWall';
    import { logger, LogLevel } from './src/utils/Logger';

    logger.setLogLevel(LogLevel.INFO);

    const logs = document.getElementById('logs');
    function log(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = `log ${type}`;
      div.textContent = msg;
      logs.appendChild(div);
      logs.scrollTop = logs.scrollHeight;
      console.log(msg);
    }

    // Setup THREE.js scene
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a1a1a);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(5, 3, 5);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth - 400, window.innerHeight);
    document.getElementById('viewer').appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);

    // Lights
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(10, 10, 5);
    scene.add(directionalLight);

    // Grid
    const gridHelper = new THREE.GridHelper(20, 20);
    scene.add(gridHelper);

    // Axes
    const axesHelper = new THREE.AxesHelper(5);
    scene.add(axesHelper);

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // Initialize engines
    log('Initializing engines...', 'info');
    const paramEngine = new ParameterEngine();
    const geomEngine = new GeometryEngineWrapper();

    await geomEngine.initialize({ wasmPath: '/node_modules/web-ifc/' });
    log('✓ Engines initialized', 'info');

    let wall = null;

    // Button handlers
    document.getElementById('btn-create-wall').addEventListener('click', () => {
      log('=== CREATING WALL ===', 'info');

      wall = new ParametricWall(paramEngine, geomEngine, {
        startPoint: new THREE.Vector3(-3, 0, 0),
        endPoint: new THREE.Vector3(3, 0, 0),
        height: 2743,
        thickness: 114,
      });

      const mesh = wall.getMesh();
      scene.add(mesh);

      log(`✓ Wall created: ${wall.name}`, 'info');
      log(`  Vertices: ${mesh.geometry.attributes.position.count}`, 'info');
      log(`  Openings: ${wall.getOpenings().length}`, 'info');
    });

    document.getElementById('btn-add-opening').addEventListener('click', () => {
      if (!wall) {
        log('❌ Create wall first!', 'error');
        return;
      }

      log('=== ADDING OPENING ===', 'info');

      const beforeVertices = wall.getMesh().geometry.attributes.position.count;
      log(`Before: ${beforeVertices} vertices`, 'info');

      const opening = wall.addOpening({
        type: 'window',
        position: 0.5,
        width: 914,
        height: 914,
        sillHeight: 900,
      });

      const afterVertices = wall.getMesh().geometry.attributes.position.count;
      log(`After: ${afterVertices} vertices`, 'info');

      if (beforeVertices === afterVertices) {
        log('❌ GEOMETRY NOT MODIFIED!', 'error');
      } else {
        log(`✓ Geometry changed: ${beforeVertices} → ${afterVertices}`, 'info');
      }

      log(`  Openings in array: ${wall.getOpenings().length}`, 'info');
    });

    document.getElementById('btn-dump-state').addEventListener('click', () => {
      if (!wall) {
        log('❌ No wall to dump', 'error');
        return;
      }

      log('=== WALL STATE ===', 'info');
      log(`Name: ${wall.name}`, 'info');
      log(`Openings: ${wall.getOpenings().length}`, 'info');

      const mesh = wall.getMesh();
      log(`Mesh exists: ${!!mesh}`, 'info');
      log(`Geometry exists: ${!!mesh.geometry}`, 'info');
      log(`Vertices: ${mesh.geometry.attributes.position.count}`, 'info');
      log(`In scene: ${scene.children.includes(mesh)}`, 'info');

      wall.getOpenings().forEach((opening, i) => {
        log(`  Opening ${i}: ${opening.type} at ${opening.position}`, 'info');
      });
    });

    window.wall = wall;
    window.scene = scene;
  </script>
</body>
</html>
